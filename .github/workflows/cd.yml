name: Continuous Deployment

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Prevent concurrent deployments
    concurrency:
      group: deployment
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Validate that required secrets are set
      - name: Validate GitHub Secrets
        run: |
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "‚ùå ERROR: EC2_HOST secret is not set"
            echo ""
            echo "Please add GitHub Secrets:"
            echo "  1. Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "  2. Add EC2_HOST: Your EC2 instance public IP or DNS"
            echo "  3. Add EC2_USER: SSH username (e.g., ec2-user, ubuntu)"
            echo "  4. Add EC2_SSH_KEY: Your private SSH key (4096-bit RSA)"
            echo ""
            echo "See docs/GITHUB_SECRETS_SETUP.md for detailed instructions."
            exit 1
          fi

          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "‚ùå ERROR: EC2_USER secret is not set"
            exit 1
          fi

          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "‚ùå ERROR: EC2_SSH_KEY secret is not set"
            exit 1
          fi

          echo "‚úÖ All required secrets are set"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          # EC2_HOST: Public IP address of your EC2 instance
          # Example: 54.123.45.67 or deploy.example.com
          host: ${{ secrets.EC2_HOST }}

          # EC2_USER: SSH username
          # Typically: ec2-user (Amazon Linux) or ubuntu (Ubuntu AMI)
          username: ${{ secrets.EC2_USER }}

          # EC2_SSH_KEY: Private SSH key (4096-bit RSA minimum)
          # Should include -----BEGIN RSA PRIVATE KEY----- headers
          key: ${{ secrets.EC2_SSH_KEY }}

          port: 22
          timeout: 60s
          command_timeout: 30m
          script: |
            set -e  # Exit on first error
            set -x  # Print commands for debugging

            echo "üöÄ Starting deployment..."

            # Set variables
            APP_DIR="/home/${{ secrets.EC2_USER }}/forum-api"

            # Step 1: Verify directory exists
            echo "üìÅ Checking application directory..."
            if [ ! -d "$APP_DIR" ]; then
              echo "‚ùå ERROR: Application directory does not exist: $APP_DIR"
              echo "Please ensure the directory exists on EC2 and git is initialized"
              exit 1
            fi

            # Step 2: Navigate to app directory
            echo "üìç Entering application directory..."
            cd "$APP_DIR" || exit 1

            # Step 3: Verify git repository
            echo "üîç Verifying git repository..."
            if [ ! -d ".git" ]; then
              echo "‚ùå ERROR: Not a git repository"
              echo "Run: git init && git remote add origin <repo-url>"
              exit 1
            fi

            # Step 4: Pull latest code
            echo "‚¨áÔ∏è  Pulling latest code from ${{ github.ref_name }}..."
            git fetch origin --quiet
            git reset --hard origin/${{ github.ref_name }} || git checkout -b ${{ github.ref_name }} origin/${{ github.ref_name }}
            echo "‚úÖ Code updated successfully"

            # Step 5: Install dependencies
            echo "üì¶ Installing dependencies..."
            npm ci --production --silent
            echo "‚úÖ Dependencies installed"

            # Step 6: Run database migrations
            echo "üóÑÔ∏è Running database migrations..."
            npm run migrate || (echo "‚ö†Ô∏è Warning: Migration failed (may need manual intervention)" && true)
            echo "‚úÖ Migration check complete"

            # Step 7: Stop current application
            echo "üõë Stopping current application..."
            sudo systemctl stop forum-api || true
            sleep 2

            # Step 8: Restart application
            echo "üîÑ Restarting application service..."
            sudo systemctl start forum-api
            sleep 3

            # Step 9: Verify service is running
            echo "üîç Checking if service is running..."
            if ! sudo systemctl is-active --quiet forum-api; then
              echo "‚ùå ERROR: Service is not running"
              echo "Logs:"
              sudo journalctl -u forum-api -n 20 --no-pager
              exit 1
            fi
            echo "‚úÖ Service is running"

            # Step 10: Health check
            echo "üè• Running health check..."
            for i in {1..5}; do
              if curl -s http://localhost:5000 > /dev/null; then
                echo "‚úÖ Health check passed"
                break
              fi
              if [ $i -lt 5 ]; then
                echo "‚è≥ Waiting... (attempt $i/5)"
                sleep 2
              else
                echo "‚ùå ERROR: Health check failed after 5 attempts"
                echo "Recent logs:"
                sudo journalctl -u forum-api -n 10 --no-pager
                exit 1
              fi
            done

            echo "üéâ Deployment completed successfully!"

      - name: Notify deployment success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Deployment successful!'
            })

      - name: Notify deployment failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Deployment failed! Please check the logs.'
            })
