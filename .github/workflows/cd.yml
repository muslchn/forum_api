name: Continuous Deployment

on:
  # Deploy only after CI completes successfully to avoid releasing broken builds.
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      statuses: write

    # Prevent concurrent deployments
    concurrency:
      group: deployment
      cancel-in-progress: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Validate that required secrets are set
      - name: Validate GitHub Secrets
        run: |
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "‚ùå ERROR: EC2_HOST secret is not set"
            echo ""
            echo "Please add GitHub Secrets:"
            echo "  1. Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "  2. Add EC2_HOST: Your EC2 instance public IP or DNS"
            echo "  3. Add EC2_USER: SSH username (e.g., ec2-user, ubuntu)"
            echo "  4. Add EC2_SSH_KEY: Your private SSH key (4096-bit RSA)"
            echo ""
            echo "See docs/GITHUB_SECRETS_SETUP.md for detailed instructions."
            exit 1
          fi

          if [ -z "${{ secrets.EC2_USER }}" ]; then
            echo "‚ùå ERROR: EC2_USER secret is not set"
            exit 1
          fi

          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "‚ùå ERROR: EC2_SSH_KEY secret is not set"
            exit 1
          fi

          echo "‚úÖ All required secrets are set"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          # EC2_HOST: Public IP address of your EC2 instance
          # Example: 54.123.45.67 or deploy.example.com
          host: ${{ secrets.EC2_HOST }}

          # EC2_USER: SSH username
          # Typically: ec2-user (Amazon Linux) or ubuntu (Ubuntu AMI)
          username: ${{ secrets.EC2_USER }}

          # EC2_SSH_KEY: Private SSH key (4096-bit RSA minimum)
          # Should include -----BEGIN RSA PRIVATE KEY----- headers
          key: ${{ secrets.EC2_SSH_KEY }}

          port: 22
          timeout: 60s
          command_timeout: 30m
          script: |
            set -e  # Exit on first error
            set -x  # Print commands for debugging

            echo "üöÄ Starting deployment..."

            # Set variables
            APP_DIR="/home/${{ secrets.EC2_USER }}/forum-api"

            # Step 1: Verify directory exists
            echo "üìÅ Checking application directory..."
            if [ ! -d "$APP_DIR" ]; then
              echo "‚ùå ERROR: Application directory does not exist: $APP_DIR"
              echo "Please ensure the directory exists on EC2 and git is initialized"
              exit 1
            fi

            # Step 2: Navigate to app directory
            echo "üìç Entering application directory..."
            cd "$APP_DIR" || exit 1

            # Step 3: Verify git repository
            echo "üîç Verifying git repository..."
            if [ ! -d ".git" ]; then
              echo "‚ùå ERROR: Not a git repository"
              echo "Run: git init && git remote add origin <repo-url>"
              exit 1
            fi

            # Step 4: Pull latest code
            echo "‚¨áÔ∏è  Pulling latest code from ${{ github.ref_name }}..."
            git fetch origin --quiet
            git reset --hard origin/${{ github.ref_name }} || git checkout -b ${{ github.ref_name }} origin/${{ github.ref_name }}
            echo "‚úÖ Code updated successfully"

            # Step 5: Install dependencies
            echo "üì¶ Installing dependencies..."
            npm ci --omit=dev --silent
            echo "‚úÖ Dependencies installed"

            # Step 6: Run database migrations
            echo "üóÑÔ∏è Running database migrations..."
            npm run migrate || (echo "‚ö†Ô∏è Warning: Migration failed (may need manual intervention)" && true)
            echo "‚úÖ Migration check complete"

            # Step 7: Stop current application
            echo "üõë Stopping current application..."
            sudo systemctl stop forum-api || true
            sleep 2

            # Step 8: Restart application
            echo "üîÑ Restarting application service..."
            sudo systemctl start forum-api
            sleep 3

            # Step 9: Verify service is running
            echo "üîç Checking if service is running..."
            if ! sudo systemctl is-active --quiet forum-api; then
              echo "‚ùå ERROR: Service is not running"
              echo "Logs:"
              sudo journalctl -u forum-api -n 20 --no-pager
              exit 1
            fi
            echo "‚úÖ Service is running"

            # Step 10: Health check with response validation
            echo "üè• Running health check..."
            HEALTH_CHECK_SUCCESS=false
            for i in {1..5}; do
              # Fetch response with HTTP status code
              RESPONSE=$(curl -fsS -w "\n%{http_code}" http://localhost:5000/health 2>/dev/null || echo -e "\n000")
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')

              # Validate HTTP 200
              if [ "$HTTP_CODE" != "200" ]; then
                if [ $i -lt 5 ]; then
                  echo "‚è≥ HTTP $HTTP_CODE - Waiting... (attempt $i/5)"
                  sleep 2
                fi
                continue
              fi

              # Validate JSON response contains status=success
              if echo "$BODY" | grep -q '"status":"success"'; then
                echo "‚úÖ Health check passed (HTTP 200, valid response)"
                HEALTH_CHECK_SUCCESS=true
                break
              else
                echo "‚ö†Ô∏è  HTTP 200 but invalid response: $BODY"
                if [ $i -lt 5 ]; then
                  echo "‚è≥ Retrying... (attempt $i/5)"
                  sleep 2
                fi
              fi
            done

            if [ "$HEALTH_CHECK_SUCCESS" != "true" ]; then
              echo "‚ùå ERROR: Health check failed after 5 attempts"
              echo "Recent logs:"
              sudo journalctl -u forum-api -n 15 --no-pager
              exit 1
            fi

            echo "üéâ Deployment completed successfully!"

      - name: Update commit status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const description = state === 'success'
              ? 'Deployment successful!'
              : 'Deployment failed. Check workflow logs.';
            const targetUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state,
              description,
              context: 'deployment/ec2',
              target_url: targetUrl,
            });
